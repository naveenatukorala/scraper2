var handlers={scraperScrapeTab:function(b,c,d){chrome.tabs.sendRequest(parseInt(b.tab,10),{command:"scraperScrape",payload:b.options},d)},scraperSpreadsheet:function(b,c,d){chrome.identity.getAuthToken({interactive:!0},function(c){if(chrome.runtime.lastError)d({error:chrome.runtime.lastError});else{var e=b.title||"",f="scraper-"+Date.now()+"-"+Math.round(1E6*Math.random()),k={Authorization:"Bearer "+c,"Content-Type":'multipart/related; boundary="'+f+'"'},e={title:e},a;a=""+("--"+f+"\n")+"Content-Type: application/json; charset=UTF-8\n";
a+="\n";a+=JSON.stringify(e);a+="\n";a+="--"+f+"\n";a+="Content-Type: text/csv\n";a+="\n";a+=b.csv;a+="\n";a+="--"+f+"--\n";var h=new XMLHttpRequest;h.open("POST","https://www.googleapis.com/upload/drive/v2/files?uploadType=multipart&convert=true",!0);Object.keys(k).forEach(function(a){h.setRequestHeader(a,k[a])});h.onload=function(){var a=this.response;if(401==this.status)chrome.identity.removeCachedAuthToken({token:c}),d({error:"Google authentication failed. Please try exporting again, and you will be re-authenticated."});
else if(100>this.status-200)try{var b=JSON.parse(a);b&&b.alternateLink&&chrome.tabs.create({url:b.alternateLink});d(b)}catch(e){d({error:e})}else d({error:"Received an unexpected response.\n\n"+a})};h.send(a)}})},scraperExportClipboard:function(b,c,d){c=document.createElement("textarea");document.body.appendChild(c);c.value=b.body;c.focus();c.select();document.execCommand("Copy");c.remove();d()},scraperExportCSV:function(b,c,d){var g=function(){d({error:"Sorry, an error occurred when trying to save your file."});
console.log(arguments)};chrome.fileSystem.chooseEntry({type:"saveFile"},function(c){c.createWriter(function(f){f.onerror=g;f.onwriteend=function(b){console.log("write complete");chrome.fileSystem.getDisplayPath(c,function(a){console.log(a);d({path:a})})};f.write(new Blob([b.body],{type:"text/csv"}))},g)})}};
chrome.extension.onRequest.addListener(function(b,c,d){if("object"===typeof b&&"command"in b&&"payload"in b){var g=b.command;b=b.payload;var e=handlers[g];"function"===typeof e?e(b,c,d):console.error("no handler for command: "+g)}else console.error("invalid request object: ",b)});
bit155.scraper.presets()||bit155.scraper.presets([{name:"Paragraph Text",options:{language:"xpath",selector:"//p",attributes:[{xpath:".",name:"Text"}],filters:["empty"]}},{name:"Links",options:{language:"xpath",selector:"//a",attributes:[{xpath:".",name:"Link"},{xpath:"@href",name:"URL"}],filters:["empty"]}}]);
var scrapeSimilarItem=chrome.contextMenus.create({title:"Scrape similar...",contexts:["all"],onclick:function(b,c){var d=!1;chrome.tabs.sendRequest(c.id,{command:"scraperSelectionOptions"},function(b){d=!0;bit155.scraper.viewer(c,b)});setTimeout(function(){!d&&confirm("You need to reload this page before you can use Scraper. Press ok if you would like to reload it now, or cancel if not.")&&chrome.tabs.update(c.id,{url:"javascript:window.location.reload()"})},500)}});
